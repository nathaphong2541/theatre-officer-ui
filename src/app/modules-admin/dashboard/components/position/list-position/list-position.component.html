<div class="p-4 sm:p-6">
    <!-- Header -->
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-xl sm:text-2xl font-semibold text-slate-900">Position</h1>
                <span
                    class="hidden sm:inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
                    Master Data
                </span>
            </div>
            <p class="text-sm text-slate-500 mt-1">รายการข้อมูลตำแหน่ง (Position)</p>
        </div>

        <button type="button" (click)="openCreate()"
            class="inline-flex w-full sm:w-auto items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 active:bg-blue-800">
            <i class="fa-solid fa-plus"></i>
            เพิ่ม Position
        </button>
    </div>

    <!-- Alerts -->
    <div *ngIf="error" class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
        {{ error }}
    </div>

    <div *ngIf="loading" class="mt-4 rounded-xl border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-700">
        กำลังโหลด...
    </div>

    <!-- Table Card -->
    <div class="mt-4 rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-[980px] w-full text-left text-sm">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th class="px-4 py-3 font-semibold w-[80px]">#</th>
                        <th class="px-4 py-3 font-semibold">ชื่ออังกฤษ</th>
                        <th class="px-4 py-3 font-semibold">ชื่อไทย</th>
                        <th class="px-4 py-3 font-semibold w-[260px]">Department</th>
                        <th class="px-4 py-3 font-semibold">รายละเอียด</th>
                        <th class="px-4 py-3 font-semibold text-right w-[220px]">Actions</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-slate-100">
                    <tr *ngFor="let p of positions; let i = index; trackBy: trackById"
                        class="hover:bg-slate-50/70 transition">
                        <td class="px-4 py-3 text-slate-600">{{ page * size + i + 1 }}</td>
                        <td class="px-4 py-3 text-slate-800">{{ p.nameEn }}</td>
                        <td class="px-4 py-3 font-medium text-slate-900">{{ p.nameTh }}</td>
                        <td class="px-4 py-3">
                            <div class="font-medium text-slate-900">
                                {{ getDepartmentName(p.departmentId) }}
                            </div>
                            <div class="text-xs text-slate-500">
                                ID: {{ p.departmentId }}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-slate-500">{{ p.description || '-' }}</td>

                        <td class="px-4 py-3">
                            <div class="flex justify-end gap-2">
                                <button type="button" (click)="openEdit(p)"
                                    class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 hover:border-slate-300">
                                    <i class="fa-regular fa-pen-to-square"></i>
                                    แก้ไข
                                </button>

                                <button type="button" (click)="remove(p)"
                                    class="inline-flex items-center gap-2 rounded-xl border border-red-200 bg-white px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 hover:border-red-300">
                                    <i class="fa-regular fa-trash-can"></i>
                                    ลบ
                                </button>
                            </div>
                        </td>
                    </tr>

                    <tr *ngIf="!loading && positions.length === 0">
                        <td colspan="6" class="px-4 py-12 text-center text-slate-500">ไม่พบข้อมูล</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ✅ Pretty Pagination Bar -->
        <div class="border-t border-slate-100 bg-white px-4 py-3">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <!-- Left -->
                <div class="flex flex-wrap items-center gap-2 text-sm text-slate-600">
                    <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-slate-700">
                        ทั้งหมด <b class="mx-1">{{ total }}</b> รายการ
                    </span>

                    <span *ngIf="totalPages > 0"
                        class="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-blue-700">
                        หน้า <b class="mx-1">{{ page + 1 }}</b> / {{ totalPages }}
                    </span>

                    <span class="inline-flex items-center gap-2 ml-0 sm:ml-2">
                        <span class="text-slate-500">แสดงต่อหน้า</span>
                        <select
                            class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10"
                            [value]="size" (change)="changePageSize($any($event.target).value)">
                            <option *ngFor="let s of pageSizes" [value]="s">{{ s }}</option>
                        </select>
                    </span>
                </div>

                <!-- Right -->
                <div class="flex items-center justify-between sm:justify-end gap-2">
                    <button type="button" (click)="prevPage()" [disabled]="page === 0 || loading"
                        class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-chevron-left"></i>
                        ก่อนหน้า
                    </button>

                    <button type="button" (click)="nextPage()"
                        [disabled]="totalPages === 0 || page >= totalPages - 1 || loading"
                        class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        ถัดไป
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div *ngIf="modalOpen" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50" (click)="closeModal()"></div>

    <div class="relative mx-auto flex min-h-full max-w-2xl items-center justify-center p-4">
        <div class="w-full rounded-2xl bg-white shadow-xl">
            <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4">
                <h2 class="text-base sm:text-lg font-semibold text-slate-900">
                    {{ mode === 'create' ? 'เพิ่ม Position' : 'แก้ไข Position' }}
                </h2>
                <button type="button" (click)="closeModal()"
                    class="rounded-xl p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-700" aria-label="close">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <form class="px-5 py-4" [formGroup]="form" (ngSubmit)="save()">
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium text-slate-700">
                            ชื่ออังกฤษ <span class="text-red-500">*</span>
                        </label>
                        <input type="text" formControlName="nameEn" placeholder="เช่น Actor"
                            class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10" />
                        <p *ngIf="form.controls.nameEn.touched && form.controls.nameEn.invalid"
                            class="mt-1 text-xs text-red-600">
                            กรุณากรอกชื่ออังกฤษ
                        </p>
                    </div>

                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium text-slate-700">
                            ชื่อไทย <span class="text-red-500">*</span>
                        </label>
                        <input type="text" formControlName="nameTh" placeholder="เช่น นักแสดง"
                            class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10" />
                        <p *ngIf="form.controls.nameTh.touched && form.controls.nameTh.invalid"
                            class="mt-1 text-xs text-red-600">
                            กรุณากรอกชื่อไทย
                        </p>
                    </div>

                    <div class="sm:col-span-2 relative">
                        <label class="block text-sm font-medium text-slate-700">
                            Department <span class="text-red-500">*</span>
                        </label>

                        <!-- Selected / Open button -->
                        <button type="button" (click)="toggleDept(true)" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-left text-sm outline-none
           focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10">
                            <span class="text-slate-900" *ngIf="form.value.departmentId as did; else chooseDept">
                                {{ getDepartmentLabelById(did) }}
                            </span>
                            <ng-template #chooseDept>
                                <span class="text-slate-400">เลือกแผนก (พิมพ์ค้นหาจากชื่อไทย/อังกฤษ)</span>
                            </ng-template>
                        </button>

                        <p *ngIf="form.controls.departmentId.touched && form.controls.departmentId.invalid"
                            class="mt-1 text-xs text-red-600">
                            กรุณาเลือก Department
                        </p>

                        <!-- Dropdown panel -->
                        <div *ngIf="deptOpen"
                            class="absolute z-50 mt-2 w-full rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden">
                            <div class="p-3 border-b border-slate-100">
                                <input type="text" [value]="deptSearch" (input)="deptSearch = $any($event.target).value"
                                    (keydown.escape)="toggleDept(false)"
                                    placeholder="ค้นหา เช่น ธุรการ / Administrative" class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none
         focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10" />
                            </div>

                            <div class="max-h-64 overflow-auto">
                                <button type="button" *ngFor="let d of filteredDepartments"
                                    (click)="selectDepartment(d)"
                                    class="w-full px-4 py-3 text-left text-sm hover:bg-slate-50">
                                    <div class="font-medium text-slate-900">{{ d.nameTh || '-' }}</div>
                                    <div class="text-xs text-slate-500">{{ d.nameEn || '-' }}</div>
                                </button>

                                <div *ngIf="filteredDepartments.length === 0" class="px-4 py-6 text-sm text-slate-500">
                                    ไม่พบแผนกที่ค้นหา
                                </div>
                            </div>

                            <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-end">
                                <button type="button" (click)="toggleDept(false)"
                                    class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">
                                    ปิด
                                </button>
                            </div>
                        </div>
                    </div>


                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-slate-700">รายละเอียด</label>
                        <textarea rows="3" formControlName="description" placeholder="รายละเอียดเพิ่มเติม"
                            class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10"></textarea>
                    </div>
                </div>

                <div class="mt-5 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end">
                    <button type="button" (click)="closeModal()"
                        class="w-full sm:w-auto rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                        ยกเลิก
                    </button>

                    <button type="submit" [disabled]="loading"
                        class="w-full sm:w-auto rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 disabled:opacity-60">
                        <i class="fa-regular fa-floppy-disk mr-2"></i>
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>